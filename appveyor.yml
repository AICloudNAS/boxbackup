version: 1.0.{build}-{branch}

clone_depth: 1

# Do not build on tags (GitHub only)
skip_tags: true

os: Windows Server 2012

platform:
# - x86
# - x64
  - Win32

configuration:
  - Debug
  - Release

environment:
  VisualStudioVersion: 10.0
  Generator: Visual Studio 10
  OPENSSL_VERSION: 1.0.2f
  PCRE_VERSION: 8.38
  CMAKE_UNIBUILD_DIR: '%APPVEYOR_BUILD_FOLDER%\..\cmake'

init:
# Uncomment the following two lines to enable RDP access to the virtual machine for debugging.
# - reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
# - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

build:
  parallel: true
  project: ..\cmake\BoxBackup_Windows.sln
  verbosity: quiet

install:
  # test_bbackupd needs 7zip (or cmake -E tar) to extract tar archives on Windows:
  - cinst -y --limit-output 7zip.commandline nsis.portable
  - dir "c:\Program Files"
  - dir "c:\Program Files (x86)"
  # We don't need strawberryperl on AppVeyor because there is already a Perl in c:\Perl.
  # If you are doing this on a fresh box for development, you would probably want to
  # install Chocolatey and then run:
  # cinst -y cmake.portable strawberryperl git vim visualstudio2012wdx
  # We install cmake.portable instead of cmake, to get it on the path again
  # <http://disq.us/p/xdknrt>.

  - '"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /x86'
  - if not exist %CMAKE_UNIBUILD_DIR% md %CMAKE_UNIBUILD_DIR%
  - cd %CMAKE_UNIBUILD_DIR%
  # We need to specify the generator here, in case the user has more than one installed.
  # CMake always seems to default to the latest version of Visual Studio, not the one on
  # the current PATH.
  - cmake -G "%Generator%" -A %PLATFORM% -DDEBUG=1
    -DCPACK_PACKAGE_VERSION_PATCH=0_appveyor_ci_%CONFIGURATION%
    %APPVEYOR_BUILD_FOLDER%\infrastructure\cmake\windows

  # Leave the current directory in the correct place to find the solution file using its relative path above.

test_script:
  - cd %CMAKE_UNIBUILD_DIR%\Build\boxbackup
  # - dir
  # - dir bin_bbackupd.dir
  # - dir %PLATFORM%
  # - dir %PLATFORM%\%CONFIGURATION%
  - ctest -C %CONFIGURATION% -V --interactive-debug-mode 0

on_failure:
  - type %APPVEYOR_BUILD_FOLDER%\test-*.log

on_finish:
  - cmake --build . --config %CONFIGURATION% --target package
  # AppVeyor refuses to package files outside of the project directory, so we need to copy the
  # built package files into it:
  - mkdir %APPVEYOR_BUILD_FOLDER%\packages
  - cp BoxBackup-*.zip %APPVEYOR_BUILD_FOLDER%\packages
  - cp BoxBackup-*.exe %APPVEYOR_BUILD_FOLDER%\packages

artifacts:
  - path: 'packages\BoxBackup-*.zip'
    name: Windows Client ZIP
    type: Zip
  - path: 'packages\BoxBackup-*.exe'
    name: Windows Client Installer
    type: File

deploy:
  - provider: GitHub
    draft: false
    prerelease: true
    on:
      branch: master

